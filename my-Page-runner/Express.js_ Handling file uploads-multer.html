<!DOCTYPE html>
<!-- saved from url=(0069)https://www.hacksparrow.com/webdev/express/handling-file-uploads.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Express.js: Handling file uploads</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=1"><link rel="icon" type="image/png" href="https://www.hacksparrow.com/images/favicon.png"><meta name="description" content="How to handle file uploads in Express I briefly touched the subject of file uploads in Express in &quot;Express.js: Handling / processing forms&quot;. Let&#39;s revisit that usecase and others in a more detailed m..."><link rel="stylesheet" href="./Express.js_ Handling file uploads-multer_files/bundle.css"><link rel="stylesheet" href="./Express.js_ Handling file uploads-multer_files/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous"><link href="./Express.js_ Handling file uploads-multer_files/css" rel="stylesheet"><link href="./Express.js_ Handling file uploads-multer_files/css(1)" rel="stylesheet"><link href="./Express.js_ Handling file uploads-multer_files/css(2)" rel="stylesheet"><meta property="og:url" content="https://www.hacksparrow.com/webdev/express/handling-file-uploads.html"><meta property="og:type" content="website"><meta property="og:title" content="Express.js: Handling file uploads"><meta property="og:description" content="How to handle file uploads in Express I briefly touched the subject of file uploads in Express in &quot;Express.js: Handling / processing forms&quot;. Let&#39;s revisit that usecase and others in a more detailed m..."><meta property="og:image" content="https://source.unsplash.com/200x200/?nature,water,sea,river,tree,space,cloud,sky,wave"><style type="text/css" data-fbcssmodules="css:fb.css.base css:fb.css.dialog css:fb.css.iframewidget css:fb.css.customer_chat_plugin_iframe">.fb_hidden{position:absolute;top:-10000px;z-index:10001}.fb_reposition{overflow:hidden;position:relative}.fb_invisible{display:none}.fb_reset{background:none;border:0;border-spacing:0;color:#000;cursor:auto;direction:ltr;font-family:'lucida grande', tahoma, verdana, arial, sans-serif;font-size:11px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:1;margin:0;overflow:visible;padding:0;text-align:left;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;visibility:visible;white-space:normal;word-spacing:normal}.fb_reset>div{overflow:hidden}@keyframes fb_transform{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}.fb_animate{animation:fb_transform .3s forwards}
.fb_hidden{position:absolute;top:-10000px;z-index:10001}.fb_reposition{overflow:hidden;position:relative}.fb_invisible{display:none}.fb_reset{background:none;border:0;border-spacing:0;color:#000;cursor:auto;direction:ltr;font-family:'lucida grande', tahoma, verdana, arial, sans-serif;font-size:11px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:1;margin:0;overflow:visible;padding:0;text-align:left;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;visibility:visible;white-space:normal;word-spacing:normal}.fb_reset>div{overflow:hidden}@keyframes fb_transform{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}.fb_animate{animation:fb_transform .3s forwards}
.fb_dialog{background:rgba(82, 82, 82, .7);position:absolute;top:-10000px;z-index:10001}.fb_dialog_advanced{border-radius:8px;padding:10px}.fb_dialog_content{background:#fff;color:#373737}.fb_dialog_close_icon{background:url(https://connect.facebook.net/rsrc.php/v3/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 0 transparent;cursor:pointer;display:block;height:15px;position:absolute;right:18px;top:17px;width:15px}.fb_dialog_mobile .fb_dialog_close_icon{left:5px;right:auto;top:5px}.fb_dialog_padding{background-color:transparent;position:absolute;width:1px;z-index:-1}.fb_dialog_close_icon:hover{background:url(https://connect.facebook.net/rsrc.php/v3/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -15px transparent}.fb_dialog_close_icon:active{background:url(https://connect.facebook.net/rsrc.php/v3/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -30px transparent}.fb_dialog_iframe{line-height:0}.fb_dialog_content .dialog_title{background:#6d84b4;border:1px solid #365899;color:#fff;font-size:14px;font-weight:bold;margin:0}.fb_dialog_content .dialog_title>span{background:url(https://connect.facebook.net/rsrc.php/v3/yd/r/Cou7n-nqK52.gif) no-repeat 5px 50%;float:left;padding:5px 0 7px 26px}body.fb_hidden{height:100%;left:0;margin:0;overflow:visible;position:absolute;top:-10000px;transform:none;width:100%}.fb_dialog.fb_dialog_mobile.loading{background:url(https://connect.facebook.net/rsrc.php/v3/ya/r/3rhSv5V8j3o.gif) white no-repeat 50% 50%;min-height:100%;min-width:100%;overflow:hidden;position:absolute;top:0;z-index:10001}.fb_dialog.fb_dialog_mobile.loading.centered{background:none;height:auto;min-height:initial;min-width:initial;width:auto}.fb_dialog.fb_dialog_mobile.loading.centered #fb_dialog_loader_spinner{width:100%}.fb_dialog.fb_dialog_mobile.loading.centered .fb_dialog_content{background:none}.loading.centered #fb_dialog_loader_close{clear:both;color:#fff;display:block;font-size:18px;padding-top:20px}#fb-root #fb_dialog_ipad_overlay{background:rgba(0, 0, 0, .4);bottom:0;left:0;min-height:100%;position:absolute;right:0;top:0;width:100%;z-index:10000}#fb-root #fb_dialog_ipad_overlay.hidden{display:none}.fb_dialog.fb_dialog_mobile.loading iframe{visibility:hidden}.fb_dialog_mobile .fb_dialog_iframe{position:sticky;top:0}.fb_dialog_content .dialog_header{background:linear-gradient(from(#738aba), to(#2c4987));border-bottom:1px solid;border-color:#043b87;box-shadow:white 0 1px 1px -1px inset;color:#fff;font:bold 14px Helvetica, sans-serif;text-overflow:ellipsis;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0;vertical-align:middle;white-space:nowrap}.fb_dialog_content .dialog_header table{height:43px;width:100%}.fb_dialog_content .dialog_header td.header_left{font-size:12px;padding-left:5px;vertical-align:middle;width:60px}.fb_dialog_content .dialog_header td.header_right{font-size:12px;padding-right:5px;vertical-align:middle;width:60px}.fb_dialog_content .touchable_button{background:linear-gradient(from(#4267B2), to(#2a4887));background-clip:padding-box;border:1px solid #29487d;border-radius:3px;display:inline-block;line-height:18px;margin-top:3px;max-width:85px;padding:4px 12px;position:relative}.fb_dialog_content .dialog_header .touchable_button input{background:none;border:none;color:#fff;font:bold 12px Helvetica, sans-serif;margin:2px -12px;padding:2px 6px 3px 6px;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}.fb_dialog_content .dialog_header .header_center{color:#fff;font-size:16px;font-weight:bold;line-height:18px;text-align:center;vertical-align:middle}.fb_dialog_content .dialog_content{background:url(https://connect.facebook.net/rsrc.php/v3/y9/r/jKEcVPZFk-2.gif) no-repeat 50% 50%;border:1px solid #4a4a4a;border-bottom:0;border-top:0;height:150px}.fb_dialog_content .dialog_footer{background:#f5f6f7;border:1px solid #4a4a4a;border-top-color:#ccc;height:40px}#fb_dialog_loader_close{float:left}.fb_dialog.fb_dialog_mobile .fb_dialog_close_icon{visibility:hidden}#fb_dialog_loader_spinner{animation:rotateSpinner 1.2s linear infinite;background-color:transparent;background-image:url(https://connect.facebook.net/rsrc.php/v3/yD/r/t-wz8gw1xG1.png);background-position:50% 50%;background-repeat:no-repeat;height:24px;width:24px}@keyframes rotateSpinner{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.fb_iframe_widget{display:inline-block;position:relative}.fb_iframe_widget span{display:inline-block;position:relative;text-align:justify}.fb_iframe_widget iframe{position:absolute}.fb_iframe_widget_fluid_desktop,.fb_iframe_widget_fluid_desktop span,.fb_iframe_widget_fluid_desktop iframe{max-width:100%}.fb_iframe_widget_fluid_desktop iframe{min-width:220px;position:relative}.fb_iframe_widget_lift{z-index:1}.fb_iframe_widget_fluid{display:inline}.fb_iframe_widget_fluid span{width:100%}
.fb_mpn_mobile_landing_page_slide_out{animation-duration:200ms;animation-name:fb_mpn_landing_page_slide_out;transition-timing-function:ease-in}.fb_mpn_mobile_landing_page_slide_out_from_left{animation-duration:200ms;animation-name:fb_mpn_landing_page_slide_out_from_left;transition-timing-function:ease-in}.fb_mpn_mobile_landing_page_slide_up{animation-duration:500ms;animation-name:fb_mpn_landing_page_slide_up;transition-timing-function:ease-in}.fb_mpn_mobile_bounce_in{animation-duration:300ms;animation-name:fb_mpn_bounce_in;transition-timing-function:ease-in}.fb_mpn_mobile_bounce_out{animation-duration:300ms;animation-name:fb_mpn_bounce_out;transition-timing-function:ease-in}.fb_mpn_mobile_bounce_out_v2{animation-duration:300ms;animation-name:fb_mpn_fade_out;transition-timing-function:ease-in}.fb_customer_chat_bounce_in_v2{animation-duration:300ms;animation-name:fb_bounce_in_v2;transition-timing-function:ease-in}.fb_customer_chat_bounce_in_from_left{animation-duration:300ms;animation-name:fb_bounce_in_from_left;transition-timing-function:ease-in}.fb_customer_chat_bounce_out_v2{animation-duration:300ms;animation-name:fb_bounce_out_v2;transition-timing-function:ease-in}.fb_customer_chat_bounce_out_from_left{animation-duration:300ms;animation-name:fb_bounce_out_from_left;transition-timing-function:ease-in}.fb_invisible_flow{display:inherit;height:0;overflow-x:hidden;width:0}@keyframes fb_mpn_landing_page_slide_out{0%{margin:0 12px;width:100% - 24px}60%{border-radius:18px}100%{border-radius:50%;margin:0 24px;width:60px}}@keyframes fb_mpn_landing_page_slide_out_from_left{0%{left:12px;width:100% - 24px}60%{border-radius:18px}100%{border-radius:50%;left:12px;width:60px}}@keyframes fb_mpn_landing_page_slide_up{0%{bottom:0;opacity:0}100%{bottom:24px;opacity:1}}@keyframes fb_mpn_bounce_in{0%{opacity:.5;top:100%}100%{opacity:1;top:0}}@keyframes fb_mpn_fade_out{0%{bottom:30px;opacity:1}100%{bottom:0;opacity:0}}@keyframes fb_mpn_bounce_out{0%{opacity:1;top:0}100%{opacity:.5;top:100%}}@keyframes fb_bounce_in_v2{0%{opacity:0;transform:scale(0, 0);transform-origin:bottom right}50%{transform:scale(1.03, 1.03);transform-origin:bottom right}100%{opacity:1;transform:scale(1, 1);transform-origin:bottom right}}@keyframes fb_bounce_in_from_left{0%{opacity:0;transform:scale(0, 0);transform-origin:bottom left}50%{transform:scale(1.03, 1.03);transform-origin:bottom left}100%{opacity:1;transform:scale(1, 1);transform-origin:bottom left}}@keyframes fb_bounce_out_v2{0%{opacity:1;transform:scale(1, 1);transform-origin:bottom right}100%{opacity:0;transform:scale(0, 0);transform-origin:bottom right}}@keyframes fb_bounce_out_from_left{0%{opacity:1;transform:scale(1, 1);transform-origin:bottom left}100%{opacity:0;transform:scale(0, 0);transform-origin:bottom left}}@keyframes slideInFromBottom{0%{opacity:.1;transform:translateY(100%)}100%{opacity:1;transform:translateY(0)}}@keyframes slideInFromBottomDelay{0%{opacity:0;transform:translateY(100%)}97%{opacity:0;transform:translateY(100%)}100%{opacity:1;transform:translateY(0)}}</style></head><body class="is-page"><div id="mobile-toolbar" class="c-dragger"><div class="leftIcons"><a href="https://www.hacksparrow.com/" title="Home" id="home-icon"><i class="fas fa-home"></i></a></div><div class="rightIcons"><i title="Search this website (alt+space or /)" class="fas fa-search"></i><i title="About me &amp; the website" class="fas fa-user-cog"></i></div></div><section id="info-settings" class="c-ui-container c-hidden c-fixed-center"><div class="c-toolbar c-dragger"><div class="c-dialog-window-buttons"><div title="Close" class="c-close c-ui"><i></i></div></div><div class="c-tab-buttons"><div class="c-tab c-tab-active">About me</div><div class="c-tab c-hidden">Settings</div><div class="c-tab">Info</div></div></div><div class="c-content-area"><div id="c-about"><img src="./Express.js_ Handling file uploads-multer_files/me.jpg" onmouseover="this.src = &#39;/images/favicon.png&#39;"><h3>Hage Yaapa</h3><p>Seeker of knowledge, hacker of things. Lover of cats. Owner of unmatched enthusiasm.</p><p id="social"><a href="https://github.com/hacksparrow" title="My GitHub account - @hacksparrow"><i class="fab fa-github"></i></a> <a href="https://twitter.com/hacksparrow/" title="My Twitter account - @hacksparrow"><i class="fab fa-twitter"></i></a> <a href="mailto:captain@hxcksparrow.com" title="Send me an e-mail - captain@hxcksparrow.com"><i class="fas fa-envelope"></i></a></p></div><!----><!----></div></section><div id="inline-search" class="c-ui-container c-fixed-center c-hidden"><div class="inline-search-box c-dragger"><i class="fas fa-search"></i> <input id="inline-search-input" autocomplete="off"></div><div class="c-scrolling-container c-ui c-hidden"><ul id="inline-page-results" class="c-ui c-hidden page-list-ul"></ul></div></div><div id="bg-a" style="background-image: url(&quot;https://i.imgur.com/IOq36LZ.jpg&quot;); animation-name: fadeOut;"></div><div id="bg-b" style="animation-name: fadeIn; background-image: url(&quot;https://i.imgur.com/FALVBLd.jpg&quot;);"></div><div id="wrapper"><div id="container" class="c-ui-container c-absolute c-top-0" v-bind:class="{ &#39;c-suggested-top&#39;: suggetContainerPosition }"><div id="toolbar" class="c-dragger"><div class="leftIcons"><a href="https://www.hacksparrow.com/" title="Home" id="home-icon"><i class="fas fa-home"></i></a></div><div class="rightIcons"><i title="Search this website (alt+space or /)" class="fas fa-search"></i><i title="About me &amp; the website" class="fas fa-user-cog"></i> <i title="Print this page" onclick="window.print()" class="fas fa-print"></i></div></div><div id="content-area"><aside><div id="aside"><div id="newsletter"><div id="subscribe"><input name="email" placeholder="Your email address"> <input name="name" placeholder="Your Name"><p>Subscribe to my newsletter.</p><input type="submit" value="Subscribe" onclick="return subscribe()"></div></div></div></aside><div id="article"><article class="main-content"><header class="post-metadata"><nav class="crumbs"><ul><li class="crumb"><a href="https://www.hacksparrow.com/">Home</a></li><li class="crumb"><a href="https://www.hacksparrow.com/webdev">webdev</a></li><li class="crumb"><a href="https://www.hacksparrow.com/webdev/express">express</a></li><li><a href="https://www.hacksparrow.com/webdev/express/handling-file-uploads.html">handling-file-uploads.html</a></li></ul></nav><h1 id="title">Express.js: Handling file uploads</h1><div>May 24, 2019 &nbsp; Update: Aug 28, 2021</div><ul id="tags"><li><a href="https://www.hacksparrow.com/tags/express.js" rel="tag">#express.js</a></li><li><a href="https://www.hacksparrow.com/tags/form" rel="tag">#form</a></li><li><a href="https://www.hacksparrow.com/tags/file" rel="tag">#file</a></li><li><a href="https://www.hacksparrow.com/tags/upload" rel="tag">#upload</a></li><li><a href="https://www.hacksparrow.com/tags/multer" rel="tag">#multer</a></li></ul></header><main><h2 class="anchor" id="how-to-handle-file-uploads-in-express">How to handle file uploads in Express<span class="mark"><a href="https://www.hacksparrow.com/webdev/express/handling-file-uploads.html#how-to-handle-file-uploads-in-express">#</a></span></h2><p>I briefly touched the subject of file uploads in Express in <a href="http://localhost:3000/webdev/express/handling-processing-forms.html">"Express.js: Handling / processing forms"</a>. Let's revisit that usecase and others in a more detailed manner.</p><p>We will be using the <code>multer</code> Node module for handling file uploads. Make sure to install it in your project directory.</p><div class="code-file"><div class="code-file-name"><span class="name"><i class="fas fa-folder-open"></i>~/projects/myapp</span></div><pre><code class="language-sh hljs bash">$ npm i multer</code></pre></div><h3 class="anchor" id="1-a-basic-file-uploader-and-handler">1. A basic file uploader and handler<span class="mark"><a href="https://www.hacksparrow.com/webdev/express/handling-file-uploads.html#1-a-basic-file-uploader-and-handler">#</a></span></h3><p>Let's start with a very simple scenario where we want to upload a single file.</p><p></p><div class="warn"><code>multer</code> will process only multipart forms, so make sure to set <code>enctype</code> to "multipart/form-data" in your form.</div><p></p><p>The form:</p><div class="code-file"><div class="code-file-name"><span class="name"><i class="fas fa-file-alt"></i>./public/upload.html</span> <span class="copy" onclick="copyCode(this)" title="Copy"><i class="far fa-clipboard"></i></span></div><pre><code class="language-html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"/upload"</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">"multipart/form-data"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"wallpaper"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></code></pre></div><p>The app:</p><div class="code-file linenumbers"><div class="code-file-name"><span class="name"><i class="fas fa-file-alt"></i>./app.js</span> <span class="copy" onclick="copyCode(this)" title="Copy"><i class="far fa-clipboard"></i></span></div><pre><code class="language-js hljs javascript"><span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> app = express();
<span class="hljs-keyword">var</span> multer  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'multer'</span>);

<span class="hljs-keyword">var</span> storage = multer.diskStorage({
  <span class="hljs-attr">destination</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, file, cb</span>) </span>{
    cb(<span class="hljs-literal">null</span>, <span class="hljs-string">'./public/images/'</span>);
  },
  <span class="hljs-attr">filename</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, file, cb</span>) </span>{
    cb(<span class="hljs-literal">null</span>, <span class="hljs-built_in">Date</span>.now() + file.originalname);
  }
});

<span class="hljs-keyword">var</span> upload = multer({ <span class="hljs-attr">storage</span>: storage });

app.use(express.static(path.join(__dirname, <span class="hljs-string">'public'</span>)));

app.post(<span class="hljs-string">'/upload'</span>, upload.single(<span class="hljs-string">'wallpaper'</span>), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
  <span class="hljs-keyword">var</span> imagePath = req.file.path.replace(<span class="hljs-regexp">/^public\//</span>, <span class="hljs-string">''</span>);
  res.redirect(imagePath);
});

app.use(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, req, res, next</span>) </span>{
  <span class="hljs-keyword">if</span> (err <span class="hljs-keyword">instanceof</span> multer.MulterError) res.status(<span class="hljs-number">500</span>).send(err.message);
  <span class="hljs-keyword">else</span> next(err);
});

app.listen(<span class="hljs-number">5000</span>);</code></pre><div class="gutter"><div class="linenumber">1</div><div class="linenumber">2</div><div class="linenumber">3</div><div class="linenumber">4</div><div class="linenumber">5</div><div class="linenumber">6</div><div class="linenumber">7</div><div class="linenumber">8</div><div class="linenumber">9</div><div class="linenumber">10</div><div class="linenumber">11</div><div class="linenumber">12</div><div class="linenumber">13</div><div class="linenumber">14</div><div class="linenumber">15</div><div class="linenumber">16</div><div class="linenumber">17</div><div class="linenumber">18</div><div class="linenumber">19</div><div class="linenumber">20</div><div class="linenumber">21</div><div class="linenumber">22</div><div class="linenumber">23</div><div class="linenumber">24</div><div class="linenumber">25</div><div class="linenumber">26</div><div class="linenumber">27</div><div class="linenumber">28</div><div class="linenumber">29</div></div></div><p>The URL: <a href="http://localhost:5000/upload.html">http://localhost:5000/upload.html</a></p><p>On line number 6, we are defining the storage engine for <code>multer</code>, of the type <code>multer.diskStorage</code>.</p><p>One may wonder, "Shouldn't handling file uploads be just about defining a path for the uploaded files? Why do we need to define a storage? Isn't this obvious over-engineering?"</p><p>Contrary to what many may think about file uploads, handling file uploads is not a simple task. Consider the following:</p><ul><li>What if another file with the same name is uploaded?</li><li>What if we want to rename the uploaded files?</li><li>What if we want to detect the file type or the file extension?</li><li>What if we want to save files to different directories based on some criteria?</li><li>What if we want to ensure we allow uploads only with our predefined form field names?</li><li>What if we want to reject an upload?</li><li>What if we want to analyze the uploading file before saving it?</li><li>What if we want to re-upload the file to a cloud storage service or a CDN?</li></ul><p>The use of storage engines makes handling of all those scenario and more, very easy.</p><p>On line number 7, we are definiting the <code>destination</code> function of the storage. This defines where the uploaded file will be stored. In our case all the files will be uploaded to <code>./public/images/</code>. It can be programmed to store the files to different directories conditionally, if required.</p><p>On line number 10, we are defining the <code>filename</code> function of the storage. This function takes care of renaming the uploaded file.</p><p>Then, on line number 19, we are plugging in the <code>multer</code> middleware for handling the file upload, which is configured to accept only one file using the form field named "wallpaper". If there are more than one file field or the file field is not named "wallpaper", <code>multer</code> will throw a <code>MulterError: Unexpected field</code> error. Text fields are exempted from these errors.</p><p>On line number 24, we define an error handling middleware to help us catch error thrown by <code>multer</code>.</p><p><code>multer</code> allows you to predefine the names of the fields and how many files you are expecting in each upload. It may sound like an inconvenience, but it helps to prevent unmonitored and unwanted file uploads which can eat up your disk space.</p><h3 class="anchor" id="2-uploading-multiple-files">2. Uploading multiple files<span class="mark"><a href="https://www.hacksparrow.com/webdev/express/handling-file-uploads.html#2-uploading-multiple-files">#</a></span></h3><p>There will be situations where you want to allow more than one file to be uploaded in a go. Let's see how we can take care of those requirements.</p><p>We will rewrite the <code>/upload</code> handler according to our needs.</p><p>When you want to allow more than one file to be uploaded using the same field:</p><pre><code class="language-js hljs javascript">app.post(<span class="hljs-string">'/upload'</span>, upload.array(<span class="hljs-string">'wallpaper'</span>, <span class="hljs-number">3</span>), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
  <span class="hljs-built_in">console</span>.log(req.files);
  res.send(req.files);
});</code></pre><p>We use the <code>upload.array(fieldName[, maxCount])</code> middleware instead of <code>upload.single(fieldName)</code>. The optional <code>maxCount</code> parameter determines the number of files that can be uploaded. If the number of files exceeds the <code>maxCount</code> value, <code>multer</code> will throw a <code>MulterError: Unexpected field</code> error.</p><p>When you want to allow more than one field to be used in one upload session:</p><pre><code class="language-js hljs javascript"><span class="hljs-keyword">var</span> fields = [
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'cover'</span>, <span class="hljs-attr">maxCount</span>: <span class="hljs-number">1</span> },
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'wallpaper'</span>, <span class="hljs-attr">maxCount</span>: <span class="hljs-number">3</span> }
];

app.post(<span class="hljs-string">'/upload'</span>, upload.fields(fields), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
  <span class="hljs-built_in">console</span>.log(req.files);
  res.send(req.files);
});</code></pre><p>We use the <code>upload.fields(fields)</code> middleware, where <code>fields</code> is an array of objects with <code>name</code> and optional <code>maxCount</code> property.</p><h3 class="anchor" id="3-creating-a-custom-storage-engine">3. Creating a custom storage engine<span class="mark"><a href="https://www.hacksparrow.com/webdev/express/handling-file-uploads.html#3-creating-a-custom-storage-engine">#</a></span></h3><p>So far, we have been using the <code>multer.diskStorage</code> storage engine. It serves us well if we want to store the uploaded files on the same machine as the application. What if we want to upload the files somewhere else? Like a cloud storage service or a CDN?</p><p>We will have to write our own storage engine.</p><p></p><div class="info">If you want to see an example of a cloud storage engine, checkout <a href="https://github.com/badunk/multer-s3">https://github.com/badunk/multer-s3</a>.</div><p></p><p>We won't be building a cloud storage engine today, due to their elaborate nature, instead we will create an example storage engine that writes all files to <code>/dev/null</code>, essentially deleting them on arrival.</p><div class="code-file linenumbers"><div class="code-file-name"><span class="name"><i class="fas fa-file-alt"></i>./null-storage.js</span> <span class="copy" onclick="copyCode(this)" title="Copy"><i class="far fa-clipboard"></i></span></div><pre><code class="language-js hljs javascript"><span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDestination</span> (<span class="hljs-params">req, file, cb</span>) </span>{
  cb(<span class="hljs-literal">null</span>, <span class="hljs-string">'/dev/null'</span>);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NullStorage</span> (<span class="hljs-params">opts</span>) </span>{
  <span class="hljs-keyword">this</span>.getDestination = (opts.destination || getDestination);
}

NullStorage.prototype._handleFile = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_handleFile</span> (<span class="hljs-params">req, file, cb</span>) </span>{
  <span class="hljs-keyword">this</span>.getDestination(req, file, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, path</span>) </span>{
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> cb(err);

    <span class="hljs-keyword">var</span> outStream = fs.createWriteStream(path);

    file.stream.pipe(outStream);
    outStream.on(<span class="hljs-string">'error'</span>, cb);
    outStream.on(<span class="hljs-string">'finish'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      cb(<span class="hljs-literal">null</span>, {
        <span class="hljs-attr">path</span>: path,
        <span class="hljs-attr">size</span>: outStream.bytesWritten
      });
    });
  });
}

NullStorage.prototype._removeFile = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_removeFile</span> (<span class="hljs-params">req, file, cb</span>) </span>{
  fs.unlink(file.path, cb);
}

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">opts</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> NullStorage(opts);
}</code></pre><div class="gutter"><div class="linenumber">1</div><div class="linenumber">2</div><div class="linenumber">3</div><div class="linenumber">4</div><div class="linenumber">5</div><div class="linenumber">6</div><div class="linenumber">7</div><div class="linenumber">8</div><div class="linenumber">9</div><div class="linenumber">10</div><div class="linenumber">11</div><div class="linenumber">12</div><div class="linenumber">13</div><div class="linenumber">14</div><div class="linenumber">15</div><div class="linenumber">16</div><div class="linenumber">17</div><div class="linenumber">18</div><div class="linenumber">19</div><div class="linenumber">20</div><div class="linenumber">21</div><div class="linenumber">22</div><div class="linenumber">23</div><div class="linenumber">24</div><div class="linenumber">25</div><div class="linenumber">26</div><div class="linenumber">27</div><div class="linenumber">28</div><div class="linenumber">29</div><div class="linenumber">30</div><div class="linenumber">31</div><div class="linenumber">32</div><div class="linenumber">33</div><div class="linenumber">34</div></div></div><p>Now, <code>app.js</code> can be re-written to use our <code>NullStorage</code> storage engine.</p><div class="code-file"><div class="code-file-name"><span class="name"><i class="fas fa-file-alt"></i>./app.js</span> <span class="copy" onclick="copyCode(this)" title="Copy"><i class="far fa-clipboard"></i></span></div><pre><code class="language-js hljs javascript"><span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> app = express();
<span class="hljs-keyword">var</span> multer  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'multer'</span>);
<span class="hljs-keyword">var</span> NullStorage = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./null-storage'</span>);

<span class="hljs-keyword">var</span> storage = NullStorage({
  <span class="hljs-attr">destination</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, file, cb</span>) </span>{
    cb(<span class="hljs-literal">null</span>, <span class="hljs-string">'./public/images/'</span>);
  }
});

<span class="hljs-keyword">var</span> upload = multer({ <span class="hljs-attr">storage</span>: storage });
...</code></pre></div><h3 class="anchor" id="4-rejecting-an-upload">4. Rejecting an upload<span class="mark"><a href="https://www.hacksparrow.com/webdev/express/handling-file-uploads.html#4-rejecting-an-upload">#</a></span></h3><p>A file upload can be rejected either by the <code>filename</code> function or the <code>destination</code> function of <code>multer.diskStorage</code>. Just call the callback function with an error message or object as the first parameter.</p><p>In this example we reject the upload if the file type if not JPEG.</p><pre><code class="language-js hljs javascript"><span class="hljs-keyword">var</span> storage = multer.diskStorage({
  <span class="hljs-attr">destination</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, file, cb</span>) </span>{
    <span class="hljs-keyword">if</span> (file.mimetype !== <span class="hljs-string">'image/jpeg'</span>) <span class="hljs-keyword">return</span> cb(<span class="hljs-string">'Invalid image format'</span>);
    cb(<span class="hljs-literal">null</span>, <span class="hljs-string">'./public/images/'</span>);
  },
  <span class="hljs-attr">filename</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, file, cb</span>) </span>{
    cb(<span class="hljs-literal">null</span>, <span class="hljs-built_in">Date</span>.now() + file.originalname);
  }
});</code></pre><h3 class="anchor" id="5-forms-with-text-and-images">5. Forms with text and images<span class="mark"><a href="https://www.hacksparrow.com/webdev/express/handling-file-uploads.html#5-forms-with-text-and-images">#</a></span></h3><p>Handling forms with text and images require no additional configuration, if your app is already configured for handling images. The text data is available on the <code>req.body</code> object.</p><p>Here is an example of a form for submitting text data and uploading an image.</p><p>The form:</p><div class="code-file"><div class="code-file-name"><span class="name"><i class="fas fa-file-alt"></i>./public/upload.html</span> <span class="copy" onclick="copyCode(this)" title="Copy"><i class="far fa-clipboard"></i></span></div><pre><code class="language-html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"/upload"</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">"multipart/form-data"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"title"</span> /&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"wallpaper"</span> /&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></code></pre></div><p>The app:</p><div class="code-file"><div class="code-file-name"><span class="name"><i class="fas fa-file-alt"></i>./app.js</span> <span class="copy" onclick="copyCode(this)" title="Copy"><i class="far fa-clipboard"></i></span></div><pre><code class="language-js hljs javascript"><span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> app = express();
<span class="hljs-keyword">var</span> multer  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'multer'</span>);

<span class="hljs-keyword">var</span> storage = multer.diskStorage({
  <span class="hljs-attr">destination</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, file, cb</span>) </span>{
    cb(<span class="hljs-literal">null</span>, <span class="hljs-string">'./public/images/'</span>);
  },
  <span class="hljs-attr">filename</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, file, cb</span>) </span>{
    cb(<span class="hljs-literal">null</span>, <span class="hljs-built_in">Date</span>.now() + file.originalname);
  }
});

<span class="hljs-keyword">var</span> upload = multer({ <span class="hljs-attr">storage</span>: storage });

app.use(express.static(path.join(__dirname, <span class="hljs-string">'public'</span>)));

app.post(<span class="hljs-string">'/upload'</span>, upload.single(<span class="hljs-string">'wallpaper'</span>), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
  <span class="hljs-comment">// Text data from the form</span>
  <span class="hljs-built_in">console</span>.log(req.body);
  <span class="hljs-comment">// Details about the uploaded file</span>
  <span class="hljs-built_in">console</span>.log(req.file);
  <span class="hljs-keyword">var</span> imagePath = req.file.path.replace(<span class="hljs-regexp">/^public\//</span>, <span class="hljs-string">''</span>);
  res.redirect(imagePath);
});

app.listen(<span class="hljs-number">5000</span>);</code></pre></div><p>The URL: <a href="http://localhost:5000/upload.html">http://localhost:5000/upload.html</a></p><h2 class="anchor" id="summary">Summary<span class="mark"><a href="https://www.hacksparrow.com/webdev/express/handling-file-uploads.html#summary">#</a></span></h2><p>We can use the <code>multer</code> Node module for handling file uploads in Express. It comes with an in-build <code>diskStorage</code> engine which makes setting the upload destination, renaming the file, and rejecting the upload very easy. We can create custom storage engines for <code>multer</code> to re-upload the file to a remote services.</p><h2 class="anchor" id="references">References<span class="mark"><a href="https://www.hacksparrow.com/webdev/express/handling-file-uploads.html#references">#</a></span></h2><ol><li><a href="https://github.com/expressjs/multer">multer</a></li><li>multer - <a href="https://github.com/expressjs/multer/blob/master/StorageEngine.md">Multer Storage Engine</a></li><li>W3C - <a href="https://www.w3.org/TR/html401/interact/forms.html#h-17.13.4.2">multipart/form-data</a></li><li>W3C -<a href="https://www.w3.org/Protocols/rfc1341/7_2_Multipart.html">Multipart Content-Type</a></li></ol></main><div id="social-share" style="text-align:center;margin:20px auto;color:#dadada"><script src="./Express.js_ Handling file uploads-multer_files/sdk.js.download" async="" crossorigin="anonymous"></script><script type="text/javascript" async="" src="./Express.js_ Handling file uploads-multer_files/ga.js.download"></script><script id="facebook-jssdk" src="./Express.js_ Handling file uploads-multer_files/sdk.js(1).download"></script><script>function share(el) {
  const winWidth = 600;
  const winHeight = 300;
  const winLeft = window.top.outerWidth/2 + window.top.screenX - (winWidth/2);
  const winTop = window.top.outerHeight/2 + window.top.screenY - (winHeight/2);
  const params = 'scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no,width='+winWidth+',height='+winHeight+',left='+winLeft+',top='+winTop;
  window.open(el.href, '', params);
  return false;
}</script><a style="padding:0 5px" rel="noopener noreferrer" target="_blank" onclick="return share(this)" href="https://twitter.com/intent/tweet?text=Express.js:%20Handling%20file%20uploads%20-%20&amp;url=https://www.hacksparrow.com/webdev/express/handling-file-uploads.html"><i class="fab fa-twitter"></i> Tweet this</a> | <a style="padding:0 5px" rel="noopener noreferrer" target="_blank" onclick="return share(this)" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://www.hacksparrow.com/webdev/express/handling-file-uploads.html&amp;title=Express.js%3A%20Handling%20file%20uploads&amp;summary=How%20to%20handle%20file%20uploads%20in%20Express%20I%20briefly%20touched%20the%20subject%20of%20file%20uploads%20in%20Express%20in%20%22Express.js%3A%20Handling%20%2F%20processing%20forms%22.%20Let%27s%20revisit%20that%20usecase%20and%20others%20in%20a%20more%20detailed%20m..."><i class="fab fa-linkedin"></i> Share on LinkedIn</a> | <span style="padding:0 5px" id="fb-root" class=" fb_reset"><div style="position: absolute; top: -10000px; width: 0px; height: 0px;"><div></div></div></span><script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));</script><span class="fb-share-button fb_iframe_widget" data-href="https://www.hacksparrow.com/webdev/express/handling-file-uploads.html" data-layout="button_count" fb-xfbml-state="rendered" fb-iframe-plugin-query="app_id=&amp;container_width=0&amp;href=https%3A%2F%2Fwww.hacksparrow.com%2Fwebdev%2Fexpress%2Fhandling-file-uploads.html&amp;layout=button_count&amp;locale=en_US&amp;sdk=joey"><span style="vertical-align: bottom; width: 77px; height: 20px;"><iframe name="f315e32bd80ad78" width="1000px" height="1000px" data-testid="fb:share_button Facebook Social Plugin" title="fb:share_button Facebook Social Plugin" frameborder="0" allowtransparency="true" allowfullscreen="true" scrolling="no" allow="encrypted-media" src="./Express.js_ Handling file uploads-multer_files/share_button.html" style="border: none; visibility: visible; width: 77px; height: 20px;" class=""></iframe></span></span></div></article><div id="related"><h2>Related</h2><ul class="page-list-ul"><li><span class="title-snippet"><a href="https://www.hacksparrow.com/webdev/express/handling-processing-forms.html" class="list-header">Express.js: Handling / processing forms</a><p>How to handle forms in Express Forms can be submitted using the GET method or the POST method. GET method forms are recommended for simple forms like a search query or specifying a user id. The form ...</p></span><time datetime="May 24, 2019">May 24, 2019</time></li><li><span class="title-snippet"><a href="https://www.hacksparrow.com/webdev/express/writing-middleware.html" class="list-header">Express.js: Writing middleware</a><p>How to write Express.js middleware First, let's understand what an Express middleware is. An Express middleware is a function which is allowed to be a part of Express's request-response cycle. This f...</p></span><time datetime="May 23, 2019">May 23, 2019</time></li><li><span class="title-snippet"><a href="https://www.hacksparrow.com/webdev/express/vhost.html" class="list-header">vhost in Express.js</a><p>Wondering how to replicate the Apache vhost feature in Express.js? In case you are new to vhost, it allows a web server to listen on a single port and serve different web apps depending on the domain...</p></span><time datetime="Dec 26, 2012">Dec 26, 2012</time></li></ul></div><footer><div>Copyright © 2021 Hage Yaapa</div></footer></div></div></div><script src="./Express.js_ Handling file uploads-multer_files/highlight.min.js.download"></script><script>hljs.initHighlightingOnLoad();</script><script src="./Express.js_ Handling file uploads-multer_files/vue.js.download"></script><script src="./Express.js_ Handling file uploads-multer_files/bundle.js.download"></script><link rel="stylesheet" href="./Express.js_ Handling file uploads-multer_files/codemirror.css"><script src="./Express.js_ Handling file uploads-multer_files/javascript.js.download"></script><script src="./Express.js_ Handling file uploads-multer_files/axios.min.js.download"></script><script>var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-28435166-1']);
        _gaq.push(['_trackPageview']);
      
        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();</script></div><iframe src="./Express.js_ Handling file uploads-multer_files/globalstorage.html" style="position: absolute; width: 1px; height: 1px; left: -9999px;"></iframe></body></html>